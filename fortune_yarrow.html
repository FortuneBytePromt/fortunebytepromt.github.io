<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ˜“ç¶“æ²è“æ³•å°ˆé  | Fortune Byte</title>
  <style>
    body {
      font-family: "Noto Sans TC", "Noto Serif TC", serif, sans-serif;
      background: linear-gradient(135deg, #e8eaf6 0%, #f5e6c8 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      position: relative;
      overflow-x: hidden;
    }
    .bg-overlay {
      position: fixed;
      z-index: 0;
      left: 0; top: 0; width: 100vw; height: 100vh;
      pointer-events: none;
      background: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png') repeat, linear-gradient(135deg, #e8eaf6 0%, #f5e6c8 100%);
      opacity: 0.18;
    }
    .hexagram-card {
      position: relative;
      z-index: 1;
      max-width: 480px;
      margin: 48px auto 32px auto;
      background: rgba(255,255,255,0.92);
      border-radius: 24px;
      box-shadow: 0 8px 32px #bfa76a33, 0 1.5px 0 #e0c97f44;
      padding: 36px 28px 32px 28px;
      backdrop-filter: blur(6px);
      border: 2.5px solid #e0c97f88;
    }
    .hexagram-title {
      text-align:center; font-size:2.1em; margin-bottom:0.2em; font-family: "Noto Serif TC", serif; font-weight: bold; letter-spacing: 2px;
    }
    .input-group label { font-weight: bold; font-size: 1.1em; }
    .input-group textarea { font-size: 1.1em; border-radius: 8px; border: 1.5px solid #bfa76a; padding: 8px; margin-top: 6px; }
    .ritual-section { margin-top: 18px; }
    .ritual-progress { display: flex; justify-content: center; gap: 12px; margin: 18px 0 18px 0; }
    .ritual-dot { width: 18px; height: 18px; border-radius: 50%; background: #e0c97f44; border: 2.5px solid #bfa76a; box-shadow: 0 0 8px #bfa76a33; transition: background 0.3s, border 0.3s; }
    .ritual-dot.active { background: #bfa76a; border-color: #8d6e36; box-shadow: 0 0 16px #bfa76a88; }
    .ritual-prayer { font-family: "Noto Serif TC", serif; color: #8d6e36; font-size: 1.25em; margin-bottom: 18px; text-align: center; letter-spacing: 2px; animation: fadeIn 1.2s; font-weight: bold; text-shadow: 0 2px 8px #fffbe6, 0 0 2px #bfa76a; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    .yao-row { border-radius:8px;margin-bottom:10px;padding:8px 0 8px 0;background:rgba(255,255,255,0.7);box-shadow:0 2px 12px #bfa76a22;animation:fadeIn 0.7s; display: flex; align-items: center; gap: 8px; }
    .yao-row-bian { border: 2px solid #e67e22 !important; background: linear-gradient(90deg, #fffbe6 60%, #ffe082 100%) !important; box-shadow: 0 0 16px #ffe08288 !important; animation: ritualGlow 1.2s; }
    .yao-label { display:inline-block;width:3.5em;font-weight:bold; font-size: 1.1em; }
    .yao-symbol { font-size:1.5em;font-family:monospace;font-weight:bold; }
    .yao-type { font-weight:bold; }
    .yao-extra { color:#e67e22;font-weight:bold; }
    .yao-text { color:#888;font-size:0.98em; margin-left: 0.5em; }
    .result-block { background: #fffbe6; border-radius: 12px; box-shadow: 0 2px 12px #bfa76a22; padding: 18px 18px 12px 18px; margin-top: 18px; font-size: 1.08em; }
    .result-block b { color: #8d6e36; }
    .copy-btn { background: #bfa76a; color: #fff; border: none; border-radius: 18px; padding: 6px 18px; font-size: 1em; margin: 0 0 10px 0; cursor: pointer; float: right; transition: background 0.2s; }
    .copy-btn:hover { background: #8d6e36; }
    @media (max-width: 600px) { .hexagram-card { max-width: 98vw; padding: 18px 4vw 18px 4vw; } .yao-label { width: 2.5em; } .result-block { font-size: 0.98em; } }
  </style>
  <script src="64gua.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5479456509868941"
    crossorigin="anonymous"></script>
</head>
<body>
  <div class="bg-overlay"></div>
  <main class="hexagram-card">
    <h1 class="hexagram-title">ğŸŒ¿ æ˜“ç¶“æ²è“æ³•å°ˆé </h1>
    <div class="input-group" style="margin-bottom:18px;">
      <label for="question">è«‹è¼¸å…¥ä½ çš„åœå¦å•é¡Œï¼š</label>
      <textarea id="question" rows="2" style="width:100%;max-width:400px;"></textarea>
    </div>
    <section class="ritual-section">
      <div class="ritual-progress" id="ritualProgress"></div>
      <div id="ritualPrayer" class="ritual-prayer"></div>
      <div id="ritualYaoArea"></div>
      <button id="ritualStepBtn" class="ritual-btn" disabled>ç”¢ç”Ÿä¸‹ä¸€çˆ»</button>
      <button id="ritualResetBtn" class="ritual-btn" style="display:none;">é‡ç½®</button>
      <div id="ritualAdvancedResult" class="result-block" style="margin-top:20px;"></div>
    </section>
  </main>
  <button id="ritualMusicBtn" class="ritual-music-btn" title="æ’­æ”¾/æš«åœèƒŒæ™¯éŸ³æ¨‚">&#9835;</button>
  <script>
    // æ²è“æ³•ä¸‰è®Šæµç¨‹
    function yarrowThreeChanges() {
      let remain = 49;
      let steps = [];
      for (let i = 0; i < 3; i++) {
        let left = Math.floor(Math.random() * (remain - 1)) + 1;
        let right = remain - left;
        right -= 1;
        let leftRemain = left % 4; if (leftRemain === 0) leftRemain = 4;
        let rightRemain = right % 4; if (rightRemain === 0) rightRemain = 4;
        let remove = 1 + leftRemain + rightRemain;
        remain -= remove;
        steps.push(remove);
      }
      if (![24,28,32,36].includes(remain)) return yarrowThreeChanges();
      return {remain, steps, yao: remain/4};
    }

    // ç‹€æ…‹é›†ä¸­ç®¡ç†
    const ritualState = {
      lines: [],
      stepCount: 0,
      currentStep: 0
    };
    const yaoNames = ['åˆ','äºŒ','ä¸‰','å››','äº”','ä¸Š'];
    const ritualPrayers = [
      'è«‹éœå¿ƒå‡ç¥ï¼Œæº–å‚™é–‹å§‹ç¬¬ä¸€çˆ»ã€‚',
      'è«‹éœå¿ƒå‡ç¥ï¼Œæº–å‚™é–‹å§‹ç¬¬äºŒçˆ»ã€‚',
      'è«‹éœå¿ƒå‡ç¥ï¼Œæº–å‚™é–‹å§‹ç¬¬ä¸‰çˆ»ã€‚',
      'è«‹éœå¿ƒå‡ç¥ï¼Œæº–å‚™é–‹å§‹ç¬¬å››çˆ»ã€‚',
      'è«‹éœå¿ƒå‡ç¥ï¼Œæº–å‚™é–‹å§‹ç¬¬äº”çˆ»ã€‚',
      'è«‹éœå¿ƒå‡ç¥ï¼Œæº–å‚™é–‹å§‹ç¬¬å…­çˆ»ã€‚'
    ];
    // å•é¡Œæ¬„ä½ç›£è½ï¼Œæœªå¡«æ™‚æŒ‰éˆ•ç¦ç”¨
    document.getElementById('question').addEventListener('input', function() {
      document.getElementById('ritualStepBtn').disabled = !this.value.trim();
    });
    // ç”¢ç”Ÿä¸‹ä¸€çˆ»
    document.getElementById('ritualStepBtn').addEventListener('click', function() {
      if (!document.getElementById('question').value.trim()) return;
      if (ritualState.lines.length >= 6) return;
      const yao = yarrowThreeChanges().yao;
      ritualState.lines.push(yao);
      updateRitualProgress();
      showYaoRows();
      document.getElementById('ritualPrayer').textContent = ritualPrayers[ritualState.lines.length] || '';
      if (ritualState.lines.length === 6) {
        this.style.display = 'none';
        document.getElementById('ritualResetBtn').style.display = '';
        showRitualAdvancedResult();
        setTimeout(()=>{
          document.getElementById('ritualAdvancedResult').scrollIntoView({behavior:'smooth', block:'center'});
        }, 300);
      }
    });
    // é‡ç½®
    document.getElementById('ritualResetBtn').addEventListener('click', function() {
      ritualState.lines = [];
      ritualState.stepCount = 0;
      ritualState.currentStep = 0;
      document.getElementById('ritualYaoArea').innerHTML = '';
      document.getElementById('ritualStepBtn').style.display = '';
      document.getElementById('ritualStepBtn').textContent = 'ç”¢ç”Ÿä¸‹ä¸€çˆ»';
      document.getElementById('ritualStepBtn').disabled = !document.getElementById('question').value.trim();
      document.getElementById('ritualResetBtn').style.display = 'none';
      document.getElementById('ritualAdvancedResult').innerHTML = '';
      document.getElementById('ritualPrayer').textContent = ritualPrayers[0];
      updateRitualProgress();
    });
    // é€²åº¦æ¢
    function updateRitualProgress() {
      let html = '';
      for(let i=0;i<6;i++) {
        html += `<span class="ritual-dot${i<ritualState.lines.length?' active':''}"></span>`;
      }
      document.getElementById('ritualProgress').innerHTML = html;
    }
    // é¡¯ç¤ºå·²ç”¢ç”Ÿçš„çˆ»
    function showYaoRows() {
      let yaoHtml = '';
      for(let i=0;i<ritualState.lines.length;i++) {
        const v = ritualState.lines[i];
        let yaoType = '', yaoSymbol = '', yaoColor = '', yaoExtra = '', yaoClass = 'yao-row';
        if (v === 6) { yaoType = 'è€é™°6'; yaoSymbol = 'Ã—'; yaoColor = '#1976d2'; yaoExtra = 'ï¼ˆè®Šçˆ»ï¼‰'; yaoClass += ' yao-row-bian'; }
        else if (v === 7) { yaoType = 'å°‘é™½7'; yaoSymbol = 'â”'; yaoColor = '#bfa76a'; }
        else if (v === 8) { yaoType = 'å°‘é™°8'; yaoSymbol = 'â” â”'; yaoColor = '#1976d2'; }
        else if (v === 9) { yaoType = 'è€é™½9'; yaoSymbol = 'â—‹'; yaoColor = '#bfa76a'; yaoExtra = 'ï¼ˆè®Šçˆ»ï¼‰'; yaoClass += ' yao-row-bian'; }
        // çˆ»åé¡¯ç¤ºæ ¼å¼
        let yaoNameLabel = '';
        if (i === 0) yaoNameLabel = yaoNames[i] + (v === 6 || v === 8 ? 'å…­' : 'ä¹');
        else if (i === 5) yaoNameLabel = yaoNames[i] + (v === 6 || v === 8 ? 'å…­' : 'ä¹');
        else yaoNameLabel = (v === 6 || v === 8 ? 'å…­' : 'ä¹') + yaoNames[i];
        // çˆ»è¾­
        let baseInfo = getFullHexagramInfo(ritualState.lines);
        let baseJsonKey = Object.keys(typeof guaData!=="undefined"?guaData:{}).find(k=>k.startsWith(String(baseInfo.number).padStart(2,'0')));
        let yaoKeys = Object.keys(guaData[baseJsonKey]?.['çˆ»è¾­'] || {});
        let yaoText = guaData[baseJsonKey]?.['çˆ»è¾­'][yaoKeys[i]] || '';
        yaoHtml += `<div class="${yaoClass}">
          <span class="yao-label">${yaoNameLabel}</span>
          <span class="yao-symbol" style="color:${yaoColor};">${yaoSymbol}</span>
          <span class="yao-type" style="color:${yaoColor};">${yaoType}</span>
          <span class="yao-extra">${yaoExtra}</span>
          <span class="yao-text">çˆ»è¾­ï¼š${yaoText}</span>
        </div>`;
      }
      document.getElementById('ritualYaoArea').innerHTML = yaoHtml;
    }
    // ä¸€éµè¤‡è£½
    function copyResult() {
      const el = document.getElementById('ritualAdvancedResult');
      if (!el) return;
      const text = el.innerText;
      navigator.clipboard.writeText(text).then(()=>{
        alert('å·²è¤‡è£½çµæœï¼');
      });
    }
    // å…­çˆ»å®Œæˆæ™‚é¡¯ç¤ºçµæœ
    function showRitualAdvancedResult() {
      const q = document.getElementById('question')?.value?.trim() || '';
      let changed = ritualState.lines.map(v=>v===6?7:v===9?8:v);
      let changePos = ritualState.lines.map((v,i)=>v===6||v===9?i+1:null).filter(x=>x);
      const baseInfo = getFullHexagramInfo(ritualState.lines);
      const changedInfo = getFullHexagramInfo(changed);
      let yaoNames = ['åˆ','äºŒ','ä¸‰','å››','äº”','ä¸Š'];
      let baseJsonKey = Object.keys(typeof guaData!=="undefined"?guaData:{}).find(k=>k.startsWith(String(baseInfo.number).padStart(2,'0')));
      let changedJsonKey = Object.keys(typeof guaData!=="undefined"?guaData:{}).find(k=>k.startsWith(String(changedInfo.number).padStart(2,'0')));
      let yaoKeys = Object.keys(guaData[baseJsonKey]?.['çˆ»è¾­'] || {});
      let changedYaoKeys = Object.keys(guaData[changedJsonKey]?.['çˆ»è¾­'] || {});
      // å–å¾—è®Šçˆ»çˆ»è¾­å€å¡Š
      let yaoTextBlock = getYaoTextBlock(changePos, baseInfo, changedInfo, guaData, baseJsonKey, changedJsonKey, yaoKeys, changedYaoKeys);
      // å–å¾—åˆ¤è®€æ–¹å¼
      let interpret = getInterpretText(changePos.length);
      // å–å¾—è®Šçˆ»åç¨±
      let bianYao = changePos.length ? changePos.map(i => {
        if (i === 1) {
          return 'åˆ' + ((ritualState.lines[0] === 6 || ritualState.lines[0] === 8) ? 'å…­' : 'ä¹');
        } else if (i === 6) {
          return 'ä¸Š' + ((ritualState.lines[5] === 6 || ritualState.lines[5] === 8) ? 'å…­' : 'ä¹');
        } else {
          return ((ritualState.lines[i-1] === 6 || ritualState.lines[i-1] === 8) ? 'å…­' : 'ä¹') + yaoNames[i-1];
        }
      }).join('ã€') : 'ç„¡';
      // å–å¾—è®Šçˆ»çˆ»è¾­ï¼ˆç´”æ–‡å­—ï¼‰
      let bianYaoText = '';
      if ([1,2,4,5].includes(changePos.length)) {
        if(changePos.length===2) {
          let mainIdx = Math.max(...changePos)-1;
          let subIdx = Math.min(...changePos)-1;
          let mainLabel = '';
          if (mainIdx === 0) mainLabel = 'åˆ' + ((ritualState.lines[0] === 6 || ritualState.lines[0] === 8) ? 'å…­' : 'ä¹');
          else if (mainIdx === 5) mainLabel = 'ä¸Š' + ((ritualState.lines[5] === 6 || ritualState.lines[5] === 8) ? 'å…­' : 'ä¹');
          else mainLabel = ((ritualState.lines[mainIdx] === 6 || ritualState.lines[mainIdx] === 8) ? 'å…­' : 'ä¹') + yaoNames[mainIdx];
          let subLabel = '';
          if (subIdx === 0) subLabel = 'åˆ' + ((ritualState.lines[0] === 6 || ritualState.lines[0] === 8) ? 'å…­' : 'ä¹');
          else if (subIdx === 5) subLabel = 'ä¸Š' + ((ritualState.lines[5] === 6 || ritualState.lines[5] === 8) ? 'å…­' : 'ä¹');
          else subLabel = ((ritualState.lines[subIdx] === 6 || ritualState.lines[subIdx] === 8) ? 'å…­' : 'ä¹') + yaoNames[subIdx];
          bianYaoText = `ä¸»ï¼š${mainLabel}ï¼š${guaData[baseJsonKey]?.['çˆ»è¾­'][yaoKeys[mainIdx]]||''}\nè¼”ï¼š${subLabel}ï¼š${guaData[baseJsonKey]?.['çˆ»è¾­'][yaoKeys[subIdx]]||''}`;
        } else if(changePos.length===4) {
          let notChanged = [];
          for(let i=0;i<6;i++) if(!changePos.includes(i+1)) notChanged.push(i+1);
          let mainIdx = Math.min(...notChanged)-1;
          let subIdx = Math.max(...notChanged)-1;
          let mainLabel = '';
          if (mainIdx === 0) mainLabel = 'åˆ' + ((changed[0] === 6 || changed[0] === 8) ? 'å…­' : 'ä¹');
          else if (mainIdx === 5) mainLabel = 'ä¸Š' + ((changed[5] === 6 || changed[5] === 8) ? 'å…­' : 'ä¹');
          else mainLabel = ((changed[mainIdx] === 6 || changed[mainIdx] === 8) ? 'å…­' : 'ä¹') + yaoNames[mainIdx];
          let subLabel = '';
          if (subIdx === 0) subLabel = 'åˆ' + ((changed[0] === 6 || changed[0] === 8) ? 'å…­' : 'ä¹');
          else if (subIdx === 5) subLabel = 'ä¸Š' + ((changed[5] === 6 || changed[5] === 8) ? 'å…­' : 'ä¹');
          else subLabel = ((changed[subIdx] === 6 || changed[subIdx] === 8) ? 'å…­' : 'ä¹') + yaoNames[subIdx];
          bianYaoText = `ä¸»ï¼š${mainLabel}ï¼š${guaData[changedJsonKey]?.['çˆ»è¾­'][changedYaoKeys[mainIdx]]||''}\nè¼”ï¼š${subLabel}ï¼š${guaData[changedJsonKey]?.['çˆ»è¾­'][changedYaoKeys[subIdx]]||''}`;
        } else if(changePos.length===5) {
          let notChanged = [];
          for(let i=0;i<6;i++) if(!changePos.includes(i+1)) notChanged.push(i+1);
          let idx = notChanged[0]-1;
          let label = '';
          if (idx === 0) label = 'åˆ' + ((changed[0] === 6 || changed[0] === 8) ? 'å…­' : 'ä¹');
          else if (idx === 5) label = 'ä¸Š' + ((changed[5] === 6 || changed[5] === 8) ? 'å…­' : 'ä¹');
          else label = ((changed[idx] === 6 || changed[idx] === 8) ? 'å…­' : 'ä¹') + yaoNames[idx];
          bianYaoText = `${label}ï¼š${guaData[changedJsonKey]?.['çˆ»è¾­'][changedYaoKeys[idx]]||''}`;
        } else if(changePos.length===1) {
          let idx = changePos[0]-1;
          let label = '';
          if (idx === 0) label = 'åˆ' + ((ritualState.lines[0] === 6 || ritualState.lines[0] === 8) ? 'å…­' : 'ä¹');
          else if (idx === 5) label = 'ä¸Š' + ((ritualState.lines[5] === 6 || ritualState.lines[5] === 8) ? 'å…­' : 'ä¹');
          else label = ((ritualState.lines[idx] === 6 || ritualState.lines[idx] === 8) ? 'å…­' : 'ä¹') + yaoNames[idx];
          bianYaoText = `${label}ï¼š${guaData[baseJsonKey]?.['çˆ»è¾­'][yaoKeys[idx]]||''}`;
        }
      }
      // é¡¯ç¤ºå€å¡Š
      let html = '';
      html += `<button class='copy-btn' onclick='copyResult()'>è¤‡è£½</button>`;
      html += `<div style='margin-bottom:8px;'><b>å•é¡Œï¼š</b> ${q||'...'}</div>`;
      html += `<div style='margin-bottom:8px;'><b>æœ¬å¦ï¼š</b> ${baseInfo.name}ï¼ˆ${baseInfo.number}ï¼‰</div>`;
      if(baseInfo.text) html += `<div style='color:#888;font-size:0.98em;margin-bottom:8px;'>å¦è¾­ï¼š${baseInfo.text}</div>`;
      html += `<div style='margin-bottom:8px;'><b>è®Šå¦ï¼š</b> ${changedInfo.name}ï¼ˆ${changedInfo.number}ï¼‰</div>`;
      if(changedInfo.text) html += `<div style='color:#888;font-size:0.98em;margin-bottom:8px;'>å¦è¾­ï¼š${changedInfo.text}</div>`;
      html += `<div style='margin-bottom:8px;'><b>è®Šçˆ»ä½ç½®ï¼š</b> ${changePos.length?changePos.join('ã€'):'ç„¡'}</div>`;
      html += `<div style='margin-bottom:8px;'><b>è®Šçˆ»ï¼š</b> ${bianYao}</div>`;
      html += `<div style='margin-bottom:8px;'><b>è®Šçˆ»çˆ»è¾­ï¼š</b><br>${bianYaoText.replace(/\n/g,'<br>')||'ç„¡'}</div>`;
      html += `<div style='margin-bottom:8px;'><b>åˆ¤è®€æ–¹å¼ï¼š</b>${interpret}</div>`;
      document.getElementById('ritualAdvancedResult').innerHTML = html;
      document.getElementById('ritualPrayer').textContent = 'å…­çˆ»å·²æˆï¼Œè«‹éœå¿ƒåƒæ‚Ÿã€‚';
      document.getElementById('ritualStepBtn').style.display = 'none';
      document.getElementById('ritualResetBtn').style.display = '';
      // æ–°å¢ï¼šè‡ªå‹•ä¸Ÿçµ¦ ChatGPT
      const prompt = `å•é¡Œï¼š${q||'...'}\næœ¬å¦ï¼š${baseInfo.name}ï¼ˆ${baseInfo.number}ï¼‰\nå¦è¾­ï¼š${baseInfo.text||''}\nè®Šå¦ï¼š${changedInfo.name}ï¼ˆ${changedInfo.number}ï¼‰\nå¦è¾­ï¼š${changedInfo.text||''}\nè®Šçˆ»ä½ç½®ï¼š${changePos.length?changePos.join('ã€'):'ç„¡'}\nè®Šçˆ»ï¼š${bianYao}\nè®Šçˆ»çˆ»è¾­ï¼š\n${bianYaoText||'ç„¡'}\nåˆ¤è®€æ–¹å¼ï¼š${interpret}`;
      const url = `https://chat.openai.com/?prompt=${encodeURIComponent(prompt)}`;
      window.open(url, '_blank');
    }

    // å…±ç”¨ï¼šæ ¹æ“šè®Šçˆ»æ•¸é‡é¡¯ç¤ºçˆ»è¾­
    function getYaoTextBlock(changePos, baseInfo, changedInfo, guaData, baseJsonKey, changedJsonKey, yaoKeys, changedYaoKeys) {
      let html = '';
      if (changePos.length > 0) {
        html += `<div><b>è®Šçˆ»ï¼š</b>ç¬¬${changePos.join('ã€')}çˆ»</div>`;
      } else {
        html += `<div><b>è®Šçˆ»ï¼š</b>ç„¡</div>`;
      }
      
      if ([1,2,4,5].includes(changePos.length)) {
        html += `<div style='margin-top:8px;'><b>è®Šçˆ»çˆ»è¾­ï¼š</b><ul style='margin:0 0 0 18px;padding:0;'>`;
        if(changePos.length===2) {
          let mainIdx = Math.max(...changePos)-1;
          let subIdx = Math.min(...changePos)-1;
          html += `<li><b>ä¸»</b>ï¼šç¬¬${mainIdx+1}çˆ»ï¼š${guaData[baseJsonKey]?.['çˆ»è¾­'][yaoKeys[mainIdx]]||''}</li>`;
          html += `<li><b>è¼”</b>ï¼šç¬¬${subIdx+1}çˆ»ï¼š${guaData[baseJsonKey]?.['çˆ»è¾­'][yaoKeys[subIdx]]||''}</li>`;
        } else if(changePos.length===4) {
          let notChanged = [];
          for(let i=0;i<6;i++) if(!changePos.includes(i+1)) notChanged.push(i+1);
          let mainIdx = Math.min(...notChanged)-1;
          let subIdx = Math.max(...notChanged)-1;
          html += `<li><b>ä¸»</b>ï¼šç¬¬${mainIdx+1}çˆ»ï¼š${guaData[changedJsonKey]?.['çˆ»è¾­'][changedYaoKeys[mainIdx]]||''}</li>`;
          html += `<li><b>è¼”</b>ï¼šç¬¬${subIdx+1}çˆ»ï¼š${guaData[changedJsonKey]?.['çˆ»è¾­'][changedYaoKeys[subIdx]]||''}</li>`;
        } else if(changePos.length===5) {
          let notChanged = [];
          for(let i=0;i<6;i++) if(!changePos.includes(i+1)) notChanged.push(i+1);
          let idx = notChanged[0]-1;
          html += `<li>ç¬¬${idx+1}çˆ»ï¼š${guaData[changedJsonKey]?.['çˆ»è¾­'][changedYaoKeys[idx]]||''}</li>`;
        } else if(changePos.length===1) {
          let idx = changePos[0]-1;
          html += `<li>ç¬¬${idx+1}çˆ»ï¼š${guaData[baseJsonKey]?.['çˆ»è¾­'][yaoKeys[idx]]||''}</li>`;
        }
        
        html += `</ul></div>`;
      }
      html += `<div style='margin-top:8px;'><b>åˆ¤è®€æ–¹å¼ï¼š</b>${getInterpretText(changePos.length)}</div>`;
      return html;
    }
    // å…±ç”¨ï¼šæ ¹æ“šè®Šçˆ»æ•¸é‡çµ¦å‡ºè§£è®€å»ºè­°
    function getInterpretText(changePosLength) {
      switch(changePosLength) {
        case 0:
          return 'å…­çˆ»ä¸è®Šï¼šä»¥æœ¬å¦å¦è¾­ç‚ºä¸»ï¼Œä»£è¡¨å±€å‹¢ç©©å®šã€‚';
        case 1:
          return 'ä¸€çˆ»è®Šï¼šä»¥æœ¬å¦çš„è®Šçˆ»çˆ»è¾­ç‚ºä¸»ï¼Œæç¤ºç•¶ä¸‹é—œéµã€‚';
        case 2:
          return 'äºŒçˆ»è®Šï¼šä»çœ‹æœ¬å¦ï¼Œä»¥ä¸Šçˆ»ç‚ºä¸»ï¼Œä¸‹çˆ»ç‚ºè¼”ã€‚';
        case 3:
          return 'ä¸‰çˆ»è®Šï¼šä»¥è®Šå¦å¦è¾­ç‚ºä¸»ï¼Œæœ¬å¦ç‚ºåƒè€ƒã€‚';
        case 4:
          return 'å››çˆ»è®Šï¼šçœ‹è®Šå¦ä¸­æœªè®Šçš„ä¸‹çˆ»çˆ»è¾­ï¼Œè¼”ä»¥ä¸Šçˆ»ã€‚';
        case 5:
          return 'äº”çˆ»è®Šï¼šå–è®Šå¦ä¸­å”¯ä¸€ä¸è®Šä¹‹çˆ»ç‚ºä¸»ã€‚';
        case 6:
          return 'å…­çˆ»çš†è®Šï¼šä¹¾ç”¨ã€Œç”¨ä¹ã€ã€å¤ç”¨ã€Œç”¨å…­ã€ï¼Œå…¶é¤˜å‰‡çœ‹è®Šå¦å¦è¾­ã€‚';
        default:
          return '';
      }
    }
    // å…±ç”¨ï¼šå–å¾—è®Šçˆ»ä½ç½®
    function getChangePos(lines) {
      return lines.map((v,i)=>v===6||v===9?i+1:null).filter(x=>x);
    }
    // å…±ç”¨ï¼šå–å¾—çˆ»åé™£åˆ—
    function getYaoNames() {
      return ['åˆ','äºŒ','ä¸‰','å››','äº”','ä¸Š'];
    }
    // å…±ç”¨ï¼šæœ¬å¦/è®Šå¦å€å¡Šé¡¯ç¤º
    function getHexagramBlock(info, label) {
      let html = `<b>${label}ï¼š</b> ${info.name}ï¼ˆ${info.number}ï¼‰<br>`;
      if(info.text) html += `<div style='color:#888;font-size:0.95em;'>å¦è¾­ï¼š${info.text}</div>`;
      return html;
    }
    // å–å¾—æ­£å¼å¦åã€å¦åºè™Ÿã€å¦è¾­çš„å…±ç”¨å‡½æ•¸
    function getFullHexagramInfo(lines) {
      // é€™è£¡å‡è¨­ lines ç‚º 6 å€‹æ•¸å­—ï¼ˆ6,7,8,9ï¼‰
      // è½‰æ›ç‚ºé™°é™½ï¼ˆ1=é™½ï¼Œ0=é™°ï¼‰
      const lowerBinary = lines.slice(0,3).map(v=>(v===7||v===9)?1:0).join('');
      const upperBinary = lines.slice(3,6).map(v=>(v===7||v===9)?1:0).join('');
      const trigramBinary = ['111','000','001','010','011','100','101','110'];
      const trigramNames = ['åœ°','å¤©','æ¾¤','ç«','é›·','é¢¨','æ°´','å±±'];
      const lowerIdx = trigramBinary.indexOf(lowerBinary);
      const upperIdx = trigramBinary.indexOf(upperBinary);
      const baseKey = (lowerIdx>-1 && upperIdx>-1) ? trigramNames[upperIdx]+trigramNames[lowerIdx] : null;
      let hexName = 'æœªçŸ¥', hexNum = '', hexText = '';
      if(baseKey && typeof hexagramsMapping!=="undefined" && hexagramsMapping[baseKey]) {
        hexName = hexagramsMapping[baseKey].name;
        hexNum = hexagramsMapping[baseKey].number;
        const baseJsonKey = Object.keys(typeof guaData!=="undefined"?guaData:{}).find(k=>k.startsWith(String(hexNum).padStart(2,'0')));
        if(baseJsonKey && guaData[baseJsonKey]) {
          hexText = guaData[baseJsonKey]['å¦è¾­'] || '';
        }
      }
      return {name: hexName, number: hexNum, text: hexText, key: baseKey};
    }
  </script>
</body>
</html> 