<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š å¾Œå°ç¸½æ”¬</title>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      margin: 20px;
    }
    h1 {
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
    .highlight {
      background-color: #ffe0e0;
      font-weight: bold;
    }
    #searchBox {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      margin: 20px auto;
      display: block;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .record-block {
      background: white;
      margin: 10px auto;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 800px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š å åœç³»çµ±å¾Œå°ç¸½è¦½</h1>
  <input id="searchBox" type="text" placeholder="ğŸ” è¼¸å…¥ email æŸ¥è©¢è©²ä½¿ç”¨è€…æ‰€æœ‰å åœè¨˜éŒ„...">
  <button id="loadBtn">ğŸ”„ ç«‹å³çµ±è¨ˆä½¿ç”¨ç‹€æ³</button>
  <div id="userStats"><p>ğŸ“¦ ç›®å‰å…± 0 ç­†å åœç´€éŒ„ï¼Œä»Šæ—¥ä½¿ç”¨è€…äººæ•¸ï¼š0 äºº</p></div>
  <table id="userTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>UID</th>
        <th>ä»Šæ—¥æ¬¡æ•¸</th>
        <th>æœ€å¾Œä½¿ç”¨æ™‚é–“</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="searchResult"></div>
  <script>
    const ADMIN_UID = "fLhFeaiYwsVhDJ0O3ozFWbo2Qv22";
    let allRecords = [];

    firebase.auth().onAuthStateChanged(async user => {
      if (!user || user.uid !== ADMIN_UID) {
        alert("ç„¡æ¬Šé™");
        location.href = "index.html";
        return;
      }
      const db = firebase.firestore();
      allRecords = (await db.collection("divinationRecords").get()).docs;
      document.getElementById("userStats").innerHTML = `<p>ğŸ“¦ ç›®å‰å…± ${allRecords.length} ç­†å åœç´€éŒ„ï¼Œä»Šæ—¥ä½¿ç”¨è€…äººæ•¸ï¼šï¼Ÿ äºº</p>`;

      document.getElementById("loadBtn").addEventListener("click", () => loadStatistics(db));

      document.getElementById("searchBox").addEventListener("change", async (e) => {
        const keyword = e.target.value.trim().toLowerCase();
        const resultBox = document.getElementById("searchResult");
        resultBox.innerHTML = "";
        if (!keyword) return;

        const result = await db.collection("divinationRecords").where("email", "==", keyword).orderBy("timestamp", "desc").limit(100).get();
        if (result.empty) {
          resultBox.innerHTML = `<p style='text-align:center;color:#777;'>æ‰¾ä¸åˆ°è©²ä½¿ç”¨è€…è³‡æ–™</p>`;
          return;
        }

        result.docs.forEach(doc => {
          const d = doc.data();
          const q = d.question || "(ç„¡å…§å®¹)";
          const base = d.baseGua;
          const yao = d.yao;
          const changed = d.changedGua;
          const guaData = `ä½ ç¾åœ¨æ˜¯ç†Ÿæ‚‰æ˜“ç¶“æ¢…èŠ±æ˜“æ•¸æ•¸å­—å¦çš„å°ˆå®¶ï¼Œè«‹æ ¹æ“šæˆ‘çš„å•é¡Œé€²è¡Œè§£æ\nåš´æ ¼éµå¾ªä¸èª ä¸å ã€ä¸ç¾©ä¸å ã€ä¸ç–‘ä¸å \nå¦‚æœæœ‰ä¸Šè¿°ä¸‰ä¸å æƒ…æ³ï¼Œè«‹ä¸è¦å¹«æˆ‘å åœ\n\næˆ‘æƒ³å• ${q} é€™ä»¶äº‹ï¼Œ\nğŸ“˜ å å¾— ${base} ${yao}\nä¹‹å¦ï¼š${changed}\n\nğŸ‘‰è«‹ä»¥ä¸‹åˆ—çš„æ ¼å¼å›ç­”ï¼Œæ¯å€‹æ ¼å¼è«‹ç²¾ç°¡æ‰¼è¦çš„å›ç­”\nğŸ”® å•é¡Œè§£æ\nğŸ“˜ æœ¬å¦è§£æ\nğŸ” è®Šçˆ»è§£æ\nğŸ“™ ä¹‹å¦è§£æ\nğŸ§™â€â™‚ï¸ ç¸½çµèˆ‡å»ºè­°`;

          const block = document.createElement("div");
          const time = d.timestamp?.toDate().toLocaleString() || "";
          const line = `ğŸ§  ${q}\nğŸ“˜ ${base} ${yao} â†’ ${changed}\nğŸ•’ ${time}`;
          block.className = "record-block";
          block.innerHTML = `${line.replaceAll("\n", "<br>")}<br><br><a target="_blank" href="https://chat.openai.com/?prompt=${encodeURIComponent(guaData)}">ğŸ§  ç™¼å•è‡³ ChatGPT</a>`;
          resultBox.appendChild(block);
        });
      });
    });

    async function loadStatistics(db) {
      const todayStart = new Date();
      todayStart.setHours(0, 0, 0, 0);

      const userMap = new Map();

      allRecords.forEach(doc => {
        const data = doc.data();
        const uid = data.uid;
        const email = data.email || "(ç„¡email)";
        const timestamp = data.timestamp?.toDate?.();
        if (!userMap.has(uid)) {
          userMap.set(uid, {
            email,
            uid,
            countToday: 0,
            lastTime: timestamp
          });
        }
        const user = userMap.get(uid);
        if (timestamp > user.lastTime) user.lastTime = timestamp;
        if (timestamp >= todayStart) user.countToday++;
      });

      const stats = Array.from(userMap.values()).sort((a, b) => b.countToday - a.countToday).slice(0, 100);

      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";
      stats.forEach(u => {
        const tr = document.createElement("tr");
        if (u.countToday > 3) tr.classList.add("highlight");
        tr.innerHTML = `
          <td>${u.email}</td>
          <td>${u.uid}</td>
          <td>${u.countToday}</td>
          <td>${u.lastTime?.toLocaleString?.() || ""}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("userStats").innerHTML = `
        <p>ğŸ“¦ ç›®å‰å…± ${allRecords.length} ç­†å åœç´€éŒ„ï¼Œä»Šæ—¥ä½¿ç”¨è€…äººæ•¸ï¼š${stats.filter(s => s.countToday > 0).length} äºº</p>
      `;
    }
  </script>
</body>
</html>
